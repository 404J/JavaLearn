# Day04

## 管道

> redis 支持使用管道操作，即一次连接执行多个命令，避免大量连接占用资源

## 发布/订阅

* 发布：PUBLISH [channel] [message]
* 订阅：SUBSCRIBE [channel]: 只会监听到订阅后的消息

## 事务的支持

* WATCH: 监控某个 key ，如果在多个事务中，这个 key 发生冲突，则这个事务不执行
* MULTI: 开启事务
* EXEC: 执行

> redis 的事务特点: 是否是原子性的：官方描述为原子性的，但是如果多条指令执行期间报错, 对于执行成功的指令并不会进行回滚，redis 一方面认为回滚机制会增加 redis 的复杂性，另一方面 redis 认为指令的执行失败是人为的因素，不可避免
> redis 是单线程处理事务的。多个事务同时到达，那个事务的 EXEC 先到达，那个先执行

## 模块支持

### BloomFilter（RedisBloom）

布隆过滤器，英文叫BloomFilter，可以说是一个二进制向量和一系列随机映射函数实现。 可以用于检索一个元素是否在一个集合中。只能添加无法删除

使用场景：防止缓存穿透

## Redis 作为缓存的特点

* 数据不是全量数据
* 数据随着访问而变化
* 热点数据

> redis 如何只保存热数据？

1. 设置内存限制，当超过内存限制的时候，指定淘汰机制：LRU等
2. 设置过期时间：可以设置过期时间，可以倒计时也可以定时，且不会随着访问延长过期时间。写的时候会剔除过期时间。

> redis 如何判断某个数据是否过期？

1. 被动模式：当一个数据过期时候，不会去主动清除它，当有访问时候，判定为过期，且清除
2. 主动模式：周期性的轮询检测，保证内存中过期的数据 75% 都被清除，牺牲一些内存避免实时轮询造成性能降低

## 缓存常见的问题

* 击穿：redis 中某个数据过期或者被清理掉，然后大量请求请求该 key, 导致直接压到数据库
  解决：key 不存在时候， 使用 setnx 获得锁，从数据库取回并更新到 redis

* 雪崩：大量 key 同时过期，导致大量请求到达数据库
  解决：随机过期时间

* 穿透：客户端搜索的是库中没有的，导致直接请求到数据库。
  解决：使用布隆过滤器

* 一致性：redis 使用弱一致性
