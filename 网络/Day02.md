# Day02

## 高并发下的负载均衡
  
  > 四层负载均衡技术

  1. 添加一个四层负载均衡器
  2. 多个请求过来，由负载均衡器进行转发到多个server: Tomcat，且 Tomcat 是镜像的
  3. 四层负载均衡器为何比 Tomcat 可以处理更多的并发请求?
    1. Tomcat 和客户端进行通信需要经过七层，且 Tomcat 跑在 JVM 中
    2. 四层负载均衡器只进行数据包的转发，不需要进行七层，不会和客户端进行 TCP ‘握手’

## NAT 网络地址转换（基于三到四层, 修改 IP，来回的数据必须走均衡器）

- 家用上网路由转换（SNAT -> 源地址转换）：私有地址 + port 通过路由器进行地址转换，路由器随机申请一个端口号，数据包中的源地址转换成公网地址，然后进行互联网通信，路由器接收到 response 后，路由器根据存储 ip + port 的 map 关系，返回给相关客户端

> 私有地址即为内网地址，内网地址是不会出现在公网的。

图～～

- 基于 NAT 模式的负载均衡器（DNAT -> 目标地址转换）：类似家用上网转换，但是不同于路由器，负载均衡器替换的是数据包中的目标地址，response 回来的时候也要走负载均衡器进行目标地址转换。网络请求是非对称的 request 一般很小，response 很大，所以这种模式下，response 过大占用大量带宽，成为瓶颈（自行车进入，卡车出去）

图～～

## DR 直接路由模型（基于两层，修改 MAC，必须在一个局域网）

- DR(直接路由):优化负载均衡器转换中 response 过大问题：server 和 负载均衡器 的 IP 地址是同一个，且在同一个局域网中，但是 server 的 IP 不对外进行暴露，客户端请求到负载均衡器，报文中添加 server 的 MAC 地址，server 接收到后，直接返回到客户端

> 如何保证 server 的 IP 不对外暴露：

图～～
