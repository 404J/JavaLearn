# Day06

## 单机、单节点、单实例

* 单点故障
* 容量有限
* 压力大

> 可用性低

## AKF

* 向 X 轴扩展，添加副本，数据全量的 copy，可以实现读写分离
* 向 Y 轴扩展，根据功能拆分数据
* 向 Z 轴扩展，根据优先级，逻辑再拆分

## 数据一致性

* 强一致性：同步方式，所有节点阻塞直到数据全部一致性，单个同步失败，认为此次失败，容易破坏可用性(CAP)
* 弱一致性：异步方式，主节点返回成功即可。但是可能数据不一致
* 最终一致性：主节点和类似 kafka 的中间同步工具同步处理数据，其他节点从 kafka 中异步读取数据

> 主备和主从区别：主备中的备用节点不提供服务，主从中的从可以提供服务
> 如何保证 主节点 高可用：

## Redis 中集群模式：REPLICAOF

* 使用弱一致性，突出高性能

### 集群启动

> 某个子节点连接到主节点时候，如何同步数据？

主节点 BGSAVE 一个 RDB, 子节点 FLUSHDB , 然后同步全量数据

> 子节点宕机重启是同步增量数据还是全量数据？

同步增量数据

> 相关配置

* replicaof 127.0.0.1 6379：设置主节点
* replica-serve-stale-data：加入集群同步数据期间是否可用
* replica-read-only：子节点是否只读
* repl-backlog-size：维护的增量数据 buffer 大小，当一个子节点失去连接重连的时候，是不需要触发全量的数据同步的，子节点提供一个偏移量拿到增量的数据
* min-replicas-to-write：最少要求多少个子节点写成功。需要权衡可用性

### 哨兵 Sentinel：高可用

* 配置文件：sentinel.conf

```conf
port 26379
sentinel monitor mymaster 127.0.0.1 6379 2
```

* 启动哨兵

```shell
redis-server /path/to/sentinel.conf --sentinel
```

> 主节点宕机时候，哨兵会进行投票选举新的主节点，并更新哨兵的配置文件

* 哨兵间如何和其他哨兵进行通信？
所有哨兵连接到 master 节点，并通过 master 节点的发布订阅功能进行通信
